---
# tasks file for k8s_grafana
- name: Execute grafana role
  become: true
  become_user: "{{ kubernetes_user }}"
  block:
    - name: Create volume directory on nfs if it does not exist
      become: true
      become_user: root
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0777"
        owner: 472
        group: 472
      with_items:
        - "/home/{{ kubernetes_user }}/nfs/ssd_0/pv-grafana"

    # install prereqs
    - name: Install prereq for grafana
      ansible.builtin.include_role:
        name: utility
        tasks_from: k8s_install_j2
      vars:
        k8s_install_j2s:
          - pv/pv_grafana.j2

    - name: Install prereq for grafana
      ansible.builtin.include_role:
        name: utility
        tasks_from: k8s_install_yml
      vars:
        k8s_install_ymls:
          - files/grafana_namespace.yml
          - files/pvc_grafana.yml

    - name: Install prereq for grafana
      ansible.builtin.include_role:
        name: utility
        tasks_from: k8s_install_j2
      vars:
        k8s_install_j2s:
          - secret/grafana_admin_secret.j2

    - name: Add Grafana helm repository
      kubernetes.core.helm_repository:
        name: grafana
        repo_url: https://grafana.github.io/helm-charts

    - name: Copy values file
      ansible.builtin.copy:
        src: "files/{{ item }}"
        dest: "{{ tmpdir }}/{{ item }}"
        mode: preserve
      changed_when: false
      with_items:
        - grafana_values.yml

    - name: Copy values file
      ansible.builtin.template:
        src: values/grafana_values_var.j2
        dest: "{{ tmpdir }}/grafana_values_var.yml"
        mode: preserve
      changed_when: false

    - name: Deploy latest version of grafana chart
      kubernetes.core.helm:
        name: grafana
        chart_ref: grafana/grafana
        chart_version: 8.4.4
        update_repo_cache: true
        release_namespace: grafana-system
        create_namespace: false
        values_files:
          - "{{ tmpdir }}/grafana_values.yml"
          - "{{ tmpdir }}/grafana_values_var.yml"
        wait: true
      when: not ansible_check_mode

    - name: Remove temp files (delete file)
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      with_items:
        - "{{ tmpdir }}/grafana_values.yml"
        - "{{ tmpdir }}/grafana_values_var.yml"
      changed_when: false

    - name: Install ingress internal
      ansible.builtin.include_role:
        name: utility
        tasks_from: k8s_install_j2
      vars:
        k8s_install_j2s:
          - ingress/grafana_ingress_internal.j2

    - name: Install common dashboards grafana
      ansible.builtin.include_role:
        name: utility
        tasks_from: k8s_install_yml
      vars:
        k8s_install_ymls:
          - dashboards/kubernetes_views_global_dashboard.yml
          - dashboards/kubernetes_views_namespace_dashboard.yml
          - dashboards/kubernetes_views_nodes_dashboard.yml
          - dashboards/kubernetes_views_pods_dashboard.yml
          - dashboards/node_exporter_full_dashboard.yml
          - dashboards/mongodb_database_dashboard.yml
          - dashboards/postgresql_database_dashboard.yml
          - dashboards/rabbitmq_overview_dashboard.yml
          - dashboards/node_js_application_dashboard.yml
          - dashboards/spring_boot_observability_dashboard.yml
